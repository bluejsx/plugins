var W=Object.create;var S=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var X=m=>S(m,"__esModule",{value:!0});var se=(m,t)=>{X(m);for(var e in t)S(m,e,{get:t[e],enumerable:!0})},ne=(m,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ee(t))!re.call(m,r)&&r!=="default"&&S(m,r,{get:()=>t[r],enumerable:!(e=Y(t,r))||e.enumerable});return m},M=m=>ne(X(S(m!=null?W(te(m)):{},"default",m&&m.__esModule&&"default"in m?{get:()=>m.default,enumerable:!0}:{value:m,enumerable:!0})),m);se(exports,{default:()=>q,hmrAdder:()=>j});var T=typeof document=="undefined"?new(require("url")).URL("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("main.js",document.baseURI).href;var k=M(require("acorn"));var v=class{constructor(){this.UPDATE_LISTENER_FUNC_NAME="_bjsx_hmr_update";this.PARAM_ALTER_NAME="_blue_insert_params"}transform(t){}getImports(...t){return[]}getExports(...t){return[]}getDependentJSXComponents(t,e){return[]}getFunctions(t){return[]}getVars(t,e){return[]}fromDirectReturnToVarReturn(t){return""}getReturnValue(t){return""}getInsertRecord(){return[]}replaceCode(t,e,r,i,s=!1){let o=0;return i.filter(n=>n[0]<e[0]||s&&n[0]===e[0]).forEach(n=>o+=n[1]),i.push([e[0],t.length-e[1]+e[0]]),r.substring(0,e[0]+o)+t+r.substring(e[1]+o)}insertCode(t,e,r,i,s=!1){return this.replaceCode(t,[e,e],r,i,s)}getCodeFragment(t,e,r){let i=t[0],s=t[1];for(let o=r.length;o--;){let[n,c]=r[o];n<t[1]&&(s+=c,n<t[0]&&(i+=c))}return e.substring(i,s)}};var R=M(require("path")),C=M(require("fs")),F=class extends v{constructor(){super();this.Parser=k.Parser}transform(t,e){t=t.replace(/=>/g,"=> ").replace(/Blue\.r\(([A-Z]\w*)[ \n]*\)/g,"Blue.r($1, null)");let r=this.Parser.parse(t,{ecmaVersion:"latest",sourceType:"module"}),i=t,s=this.getImports(r.body,e),o=this.getExportedFunctions(r.body),n=this.getInsertRecord();for(let c of o){let{start:f,end:y}=c,N=this.getCodeFragment([f,y],t,n),E=this.getDependentJSXComponents(N,s);t=this.replaceCode(this.processFunctionCode(E,c,N,i),[f,y],t,n)}return t}addHotListenerInfo(t,e,r,i){var o,n;(n=t[o=e.info.src])!=null||(t[o]={varMapCode:"",listenCode:"",usedCompNames:[]});let s=t[e.info.src];s.usedCompNames.includes(e.name)||(s.varMapCode+=`${e.info.imports[e.name]}:${e.name},`,s.usedCompNames.push(e.name)),s.listenCode+=`
if(${r}.${e.refName}.${this.UPDATE_LISTENER_FUNC_NAME}){
  ${r}.${e.refName}=${r}.${e.refName}.${this.UPDATE_LISTENER_FUNC_NAME}(${e.name}, ${e.attrObjCode?e.attrObjCode:"null"});
  ${i}
}else{
  import.meta.hot.decline()
}
`}processFunctionCode(t,e,r,i){var w,B,U,H,J,O;let s=this.getInsertRecord(),o=r,n=e.body,c=n.start-e.start,f=n.end-e.start,y=n.body,N=e.params[0],E="";if(N){let a=N.start-e.start,l=N.end-e.start,u=r.substring(a,l);r=this.replaceCode(this.PARAM_ALTER_NAME,[a,l],r,s),E=`
let ${u}=${this.PARAM_ALTER_NAME};`}let g="self",b=[],$={},p,L=0,d=y==null?void 0:y.find(a=>a.type==="ReturnStatement"),A=n.type==="CallExpression"&&((B=(w=n.callee)==null?void 0:w.object)==null?void 0:B.name)==="Blue";if(d)d.argument.type==="Identifier"&&(g=d.argument.name);else if(!A)return o;let z=d&&d.argument.type==="CallExpression"&&((H=(U=d.argument.callee)==null?void 0:U.object)==null?void 0:H.name)==="Blue",Z=A?f:d.start-e.start;for(let a of r.matchAll(/Blue\.r\(/g)){let l=this.Parser.parseExpressionAt(r,a.index,{ecmaVersion:"latest",sourceType:"module"});if(l.type==="SequenceExpression"&&(l=l.expressions.find(u=>u.start===l.start)),(l==null?void 0:l.type)==="CallExpression"&&((J=l==null?void 0:l.arguments[1])==null?void 0:J.type)==="ObjectExpression"){let u=(O=l.arguments[1].properties.find(x=>{var D;return((D=x.key)==null?void 0:D.name)==="ref"}))==null?void 0:O.value.elements[0].name;if(u){p=u;break}}}for(let a of t){let l=a.node.arguments[1];if(l.type==="ObjectExpression"){a.attrObjCode=o.substring(l.start,l.end);let u=l.properties.find(x=>x.key.name==="ref");if(u){let x="",D=u.value.elements;if(a.refName=D[1].value,a.hasRef=!0,!A){for(let{type:_,start:I,end:G}of y){let P=I-e.start,K=G-e.start,Q=o.substring(P,K);_==="ExpressionStatement"&&o.indexOf(a.refName,P)===P&&(x+=`${p}.${Q};`)}for(let _ of o.matchAll(new RegExp(a.refName,"g")))try{let I=this.Parser.parseExpressionAt(o,_.index,{ecmaVersion:"latest",sourceType:"module"});(I.type==="AssignmentExpression"||I.type==="CallExpression")&&(r=this.insertCode(`${p}.`,_.index,r,s))}catch{}}this.addHotListenerInfo($,a,p,x)}else a.refName=`bjsxc_${L++}`,a.hasRef=!1,b.push(()=>{r=this.insertCode(`ref:[${p},'${a.refName}'],`,l.start+1,r,s),this.addHotListenerInfo($,a,p,"")})}else a.refName=`bjsxc_${L++}`,b.push(()=>{r=this.replaceCode(`{ref:[${p},'${a.refName}']}`,[l.start,l.start+4],r,s),this.addHotListenerInfo($,a,p,"")})}p||(p="refs",E+=`const ${p}={};`);for(let a=b.length;a--;)b[a]();let V="";if(A)E=`{${E}const ${g}=`,r=this.insertCode(`
return ${g};}`,n.end,r,s,!0);else if(z){let a=this.getCodeFragment([d.start-e.start+6,d.end-e.start],r,s);V=`const ${g}=${a}`,r=this.replaceCode(`
return ${g};`,[d.start-e.start,d.start-e.start+a.length+7],r,s)}r=this.insertCode(E,A?c:c+1,r,s);let h="";N?h=`const newElem=Blue.r(Comp, attr, ${this.PARAM_ALTER_NAME}.children)`:h="const newElem=Blue.r(Comp, attr)",h=`
${g}.${this.UPDATE_LISTENER_FUNC_NAME} = (Comp, attr) =>{
    ${h}
    ${g}.before(newElem);
    ${g}.remove();
    return newElem
  }
`;for(let a in $){let l=$[a];h+=`import.meta.hot.accept('${a}',({${l.varMapCode}})=>{${l.listenCode}});`}return h=`
${V}
if(import.meta.hot){
  ${h}
}else{
  console.warn('import.meta.hot does not exist')
}
`,r=this.insertCode(h,Z,r,s),r}resolveFilePath(t,e){let r=R.default.resolve(e,"../",t);try{let i=C.default.statSync(r);if(i.isDirectory()){let s=C.default.readdirSync(r);for(let o=s.length;o--;){let n=s[o];if(/index\.(?:[jt]sx|mdx?)$/.test(n))return t+"/"+n}}else return i.isFile()?t:!1}catch{let s=C.default.readdirSync(R.default.resolve(r,"../")),o=R.default.basename(t),n=R.default.dirname(t);for(let c=s.length;c--;){let f=s[c];if(s.indexOf(o)===0&&/\.(?:[jt]sx|mdx?)$/.test(f))return n+"/"+f}}return!1}getImports(t,e){let r={varNames:[],info:{}};for(let i of t){if(i.type!=="ImportDeclaration"||i.source.value.indexOf(".")!==0)continue;let s=this.resolveFilePath(i.source.value,e);if(!s)continue;let o={src:s,imports:{}};r.info[i.source.value]=o;for(let n of i.specifiers){let c=n.local.name;n.type==="ImportDefaultSpecifier"?o.imports[c]="default":n.type==="ImportSpecifier"&&(o.imports[c]=n.imported.name),r.varNames.push({name:c,info:o})}}return r}getExports(t){return t.filter(e=>e.type==="ExportDefaultDeclaration"||e.type==="ExportNamedDeclaration")}getExportedFunctions(t){let e=[],r=[],i=(s,o=!1)=>{let{type:n}=s;if(!o&&n==="FunctionDeclaration"||n==="ArrowFunctionExpression")e.push(s);else if(n==="VariableDeclaration")if(o)for(let c of s.declarations)r.includes(c.id.name)&&i(c.init);else for(let c of s.declarations)i(c.init);else n==="Identifier"&&r.push(s.name)};for(let s=t.length;s--;){let o=t[s];if(o.type==="ExportDefaultDeclaration"||o.type==="ExportNamedDeclaration"){let{declaration:n,specifiers:c}=o;n?i(n):c.forEach(f=>{i(f.local)})}else r.length&&i(o,!0)}return e}getDependentJSXComponents(t,e){let r=[];for(let i of t.matchAll(/Blue\.r\(([A-Z][A-z_]*)/g)){let s=i[1],o=this.Parser.parseExpressionAt(t,i.index,{ecmaVersion:"latest",sourceType:"module"});o.type==="SequenceExpression"&&(o=o.expressions.find(n=>n.start===o.start));for(let n of e.varNames)if(n.name===s){let c={name:s,info:n.info,node:o,index:i.index};r.push(c)}}return r}getVars(t,e){return[]}fromDirectReturnToVarReturn(t){return""}getReturnValue(t){return""}};var j=new F;function q({enabled:m}={enabled:!0}){return{name:"vite-plugin-blue-hmr",apply(t,{command:e}){return m&&e==="serve"},transform(t,e){if(!e.includes("node_modules")&&/\.[jt]sx$/.test(e))return j.transform(t,e)}}}0&&(module.exports={hmrAdder});
