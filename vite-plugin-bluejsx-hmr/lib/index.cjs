var Y=Object.create;var S=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var j=m=>S(m,"__esModule",{value:!0});var ne=(m,e)=>{j(m);for(var t in e)S(m,t,{get:e[t],enumerable:!0})},ie=(m,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of te(e))!se.call(m,r)&&r!=="default"&&S(m,r,{get:()=>e[r],enumerable:!(t=ee(e,r))||t.enumerable});return m},w=m=>ie(j(S(m!=null?Y(re(m)):{},"default",m&&m.__esModule&&"default"in m?{get:()=>m.default,enumerable:!0}:{value:m,enumerable:!0})),m);ne(exports,{default:()=>Z,hmrAdder:()=>q});var L=typeof document=="undefined"?new(require("url")).URL("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("main.js",document.baseURI).href;var z=w(require("acorn"));var C=class{constructor(){this.UPDATE_LISTENER_FUNC_NAME="_bjsx_hmr_update";this.PARAM_ALTER_NAME="_blue_insert_params"}transform(e){}getImports(...e){return[]}getExports(...e){return[]}getDependentJSXComponents(e,t){return[]}getFunctions(e){return[]}getVars(e,t){return[]}fromDirectReturnToVarReturn(e){return""}getReturnValue(e){return""}getInsertRecord(){return[]}replaceCode(e,t,r,o,n=!1){let s=0;return o.filter(i=>i[0]<t[0]||n&&i[0]===t[0]).forEach(i=>s+=i[1]),o.push([t[0],e.length-t[1]+t[0]]),r.substring(0,t[0]+s)+e+r.substring(t[1]+s)}insertCode(e,t,r,o,n=!1){return this.replaceCode(e,[t,t],r,o,n)}getCodeFragment(e,t,r){let o=e[0],n=e[1];for(let s=r.length;s--;){let[i,p]=r[s];i<e[1]&&(n+=p,i<e[0]&&(o+=p))}return t.substring(o,n)}};var R=w(require("path")),F=w(require("fs")),P=class extends C{constructor(){super();this.Parser=z.Parser}transform(e,t){e=e.replace(/=>/g,"=> ").replace(/Blue\.r\(([A-Z]\w*)[ \n]*\)/g,"Blue.r($1, null)");let r=this.Parser.parse(e,{ecmaVersion:"latest",sourceType:"module"}),o=e,{imports:n,exportedFuncs:s}=this.analyzeTree(r.body,t),i=this.getInsertRecord();for(let p of s){let{start:g,end:b}=p,y=this.getCodeFragment([g,b],e,i),E=this.getDependentJSXComponents(y,n);e=this.replaceCode(this.processFunctionCode(E,p,y,n,o),[g,b],e,i)}return e}addHotListenerInfo(e,t,r,o){var s,i;(i=e[s=t.info.src])!=null||(e[s]={varMapCode:"",listenCode:"",usedCompNames:[]});let n=e[t.info.src];n.usedCompNames.includes(t.name)||(n.varMapCode+=`${t.info.imports[t.name]}:${t.name},`,n.usedCompNames.push(t.name)),n.listenCode+=`
if(${r}.${t.refName}.${this.UPDATE_LISTENER_FUNC_NAME}){
  ${r}.${t.refName}=${r}.${t.refName}.${this.UPDATE_LISTENER_FUNC_NAME}(${t.name}, ${t.attrObjCode?t.attrObjCode:"null"});
  ${o}
}else{
  import.meta.hot.decline()
}
`}processFunctionCode(e,t,r,o,n){var V,B,U,J,O,X;let s=this.getInsertRecord(),i=r,p=t.body,g=p.start-t.start,b=p.end-t.start,y=p.body,E=t.params[0],I="";if(E){let a=E.start-t.start,l=E.end-t.start,u=r.substring(a,l);r=this.replaceCode(this.PARAM_ALTER_NAME,[a,l],r,s),I=`
let ${u}=${this.PARAM_ALTER_NAME};`}let d="self",_=[],$={},c,T=0,f=y==null?void 0:y.find(a=>a.type==="ReturnStatement"),x=p.type==="CallExpression"&&((B=(V=p.callee)==null?void 0:V.object)==null?void 0:B.name)==="Blue";if(f)f.argument.type==="Identifier"&&(d=f.argument.name);else if(!x)return i;let k=f&&f.argument.type==="CallExpression"&&((J=(U=f.argument.callee)==null?void 0:U.object)==null?void 0:J.name)==="Blue",G=x?b:f.start-t.start;for(let a of r.matchAll(/Blue\.r\(/g)){let l=this.Parser.parseExpressionAt(r,a.index,{ecmaVersion:"latest",sourceType:"module"});if(l.type==="SequenceExpression"&&(l=l.expressions.find(u=>u.start===l.start)),(l==null?void 0:l.type)==="CallExpression"&&((O=l==null?void 0:l.arguments[1])==null?void 0:O.type)==="ObjectExpression"){let u=(X=l.arguments[1].properties.find(N=>{var v;return((v=N.key)==null?void 0:v.name)==="ref"}))==null?void 0:X.value.elements[0].name;if(u){c=u;break}}}for(let a of e){let l=a.node.arguments[1];if(l.type==="ObjectExpression"){a.attrObjCode=i.substring(l.start,l.end);let u=l.properties.find(N=>N.key.name==="ref");if(u){let N="",v=u.value.elements;if(a.refName=v[1].value,a.hasRef=!0,!x){for(let{type:D,start:A,end:K}of y){let M=A-t.start,Q=K-t.start,W=i.substring(M,Q);D==="ExpressionStatement"&&i.indexOf(a.refName,M)===M&&(N+=`${c}.${W};`)}for(let D of i.matchAll(new RegExp(a.refName,"g")))try{let A=this.Parser.parseExpressionAt(i,D.index,{ecmaVersion:"latest",sourceType:"module"});(A.type==="AssignmentExpression"||A.type==="CallExpression")&&(r=this.insertCode(`${c}.`,D.index,r,s))}catch{}}this.addHotListenerInfo($,a,c,N)}else a.refName=`bjsxc_${T++}`,a.hasRef=!1,_.push(()=>{r=this.insertCode(`ref:[${c},'${a.refName}'],`,l.start+1,r,s),this.addHotListenerInfo($,a,c,"")})}else a.refName=`bjsxc_${T++}`,_.push(()=>{r=this.replaceCode(`{ref:[${c},'${a.refName}']}`,[l.start,l.start+4],r,s),this.addHotListenerInfo($,a,c,"")})}c||(c="refs",I+=`const ${c}={};`);for(let a=_.length;a--;)_[a]();let H="";if(x)I=`{${I}const ${d}=`,r=this.insertCode(`
return ${d};}`,p.end,r,s,!0);else if(k){let a=this.getCodeFragment([f.start-t.start+6,f.end-t.start],r,s);H=`const ${d}=${a}`,r=this.replaceCode(`
return ${d};`,[f.start-t.start,f.start-t.start+a.length+7],r,s)}r=this.insertCode(I,x?g:g+1,r,s);let h="";E?h=`const newElem=Blue.r(Comp, attr, ${this.PARAM_ALTER_NAME}.children?.map(elem=>elem.__newElem||elem))`:h="const newElem=Blue.r(Comp, attr)",h=`
${d}.${this.UPDATE_LISTENER_FUNC_NAME} = (Comp, attr) =>{
    ${h}
    ${d}.__newElem=newElem
    ${d}.before(newElem);
    ${d}.remove();
    return newElem
  }
`;for(let a in $){let l=$[a];h+=`import.meta.hot.accept('${a}',({${l.varMapCode}})=>{${l.listenCode}});`}return h=`
${H}
if(import.meta.hot){
  ${h}
}else{
  console.warn('import.meta.hot does not exist')
}
`,r=this.insertCode(h,G,r,s),r}resolveFilePath(e,t){let r=R.default.resolve(t,"../",e);try{let o=F.default.statSync(r);if(o.isDirectory()){let n=F.default.readdirSync(r);for(let s=n.length;s--;){let i=n[s];if(/index\.(?:[jt]sx|mdx?)$/.test(i))return e+"/"+i}}else return o.isFile()?e:!1}catch{let n=F.default.readdirSync(R.default.resolve(r,"../")),s=R.default.basename(e),i=R.default.dirname(e);for(let p=n.length;p--;){let g=n[p];if(n.indexOf(s)===0&&/\.(?:[jt]sx|mdx?)$/.test(g))return i+"/"+g}}return!1}analyzeTree(e,t){let r={varNames:[],info:{}},o=[],n=[];for(let s=e.length;s--;){let i=e[s];this.filterImports(i,r,t),this.filterExportedFuncs(i,o,n)}return{imports:r,exportedFuncs:o}}filterImports(e,t,r){if(e.type!=="ImportDeclaration"||e.source.value.indexOf(".")!==0)return null;let o=this.resolveFilePath(e.source.value,r);if(!o)return null;let n={src:o,imports:{}};t.info[e.source.value]=n;for(let s of e.specifiers){let i=s.local.name;s.type==="ImportDefaultSpecifier"?n.imports[i]="default":s.type==="ImportSpecifier"&&(n.imports[i]=s.imported.name),t.varNames.push({name:i,info:n})}}filterFuncs(e,t,r,o=!1){let{type:n}=e;if(!o&&n==="FunctionDeclaration"||n==="ArrowFunctionExpression")t.push(e);else if(n==="VariableDeclaration")if(o)for(let s of e.declarations)r.includes(s.id.name)&&this.filterFuncs(s.init,t,r);else for(let s of e.declarations)this.filterFuncs(s.init,t,r);else n==="Identifier"&&r.push(e.name)}filterExportedFuncs(e,t,r){if(e.type==="ExportDefaultDeclaration"||e.type==="ExportNamedDeclaration"){let{declaration:o,specifiers:n}=e;o?this.filterFuncs(o,t,r):n.forEach(s=>{this.filterFuncs(s.local,t,r)})}else r.length&&this.filterFuncs(e,t,r,!0)}getDependentJSXComponents(e,t){let r=[];for(let o of e.matchAll(/Blue\.r\(([A-Z][A-z_]*)/g)){let n=o[1],s=this.Parser.parseExpressionAt(e,o.index,{ecmaVersion:"latest",sourceType:"module"});s.type==="SequenceExpression"&&(s=s.expressions.find(i=>i.start===s.start));for(let i of t.varNames)if(i.name===n){let p={name:n,info:i.info,node:s,index:o.index};r.push(p)}}return r}getVars(e,t){return[]}fromDirectReturnToVarReturn(e){return""}getReturnValue(e){return""}};var q=new P;function Z({enabled:m}={enabled:!0}){return{name:"vite-plugin-blue-hmr",apply(e,{command:t}){return m&&t==="serve"},transform(e,t){if(!t.includes("node_modules")&&/\.[jt]sx$/.test(t))return q.transform(e,t)}}}0&&(module.exports={hmrAdder});
