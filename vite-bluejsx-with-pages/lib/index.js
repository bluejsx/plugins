import y from"directory-tree";import{resolve as s,relative as m,dirname as h}from"path";import{createServer as S}from"vite";import w from"vite-with-bluejsx";import a,{constants as P,accessSync as v,statSync as D}from"fs";import _ from"deepmerge";function $(e){var d;w(e);let o={},r=b(),t=s(r,"./pages"),i=s(r,"./.bluepages");try{D(i),a.rmSync(i,{recursive:!0})}catch{a.mkdirSync(i,{recursive:!0})}let C=y(t,{extensions:/\.(md|mdx|js|jsx|ts|tsx)$/,normalizePath:!0},({name:c},p)=>{let n=c.replace(/.[\w]+$/,"");if(n.indexOf("_")===0)return null;let u=m(r+"/pages",p),l=s(i+"/"+u,"../");a.mkdirSync(l,{recursive:!0});let f=s(l,`./${n}.html`);a.writeFileSync(s(l,`./${n}.js`),`import Component from '${m(l,p)}';import('${m(l,t)}/_app').then(({default: Page})=>document.querySelector('#app').appendChild(Page({Component,pageProps:{}})))`);let g=a.readFileSync(`${t}/_template.html`,"utf-8").replace("</body",`<script type="module" src="./${n}.js"><\/script></body`);a.writeFileSync(f,g),o[u.replace(/\//,"_").replace(/.[\w]+$/,"")]=f});return(d=e.plugins)!=null||(e.plugins=[]),e.plugins.push({name:"with-pages-listen-dir",async configureServer(c){let{watcher:p}=c;p.add(t),p.on("add",(n,u)=>{n.includes(t)&&x(c)})}}),_(e,{build:{rollupOptions:{input:o},emptyOutDir:!0,outDir:m(i,s(r,"./dist"))},root:i,publicDir:r+"/public"})}function b(){for(let e of module.paths)try{let o=h(e);return v(e,P.F_OK),o}catch{}}async function x(e){global.__vite_start_time=Date.now();let{port:o}=e.config.server;await e.close();let r=null;try{r=await S(e.config.inlineConfig)}catch(t){e.config.logger.error(t.message,{timestamp:!0});return}for(let t in r)t!=="app"&&(e[t]=r[t]);e.config.server.middlewareMode?e.config.logger.info("server restarted.",{timestamp:!0}):await e.listen(o,!0)}export{$ as default};
